# CREATE TEMP TABLE FOR YEAR/SITUATION
CREATE TABLE bet_nhl.txg_temp
as select * from betting.team_x_game
where situation = '5on5'
AND season < 2020
AND season >= 2014

# ADD MISSING OPP VARIABLES
ALTER TABLE txg_temp
ADD COLUMN xGoalsPercentageAgainst float,
ADD COLUMN corsiPercentageAgainst float, 
ADD COLUMN fenwickPercentageAgainst float; 

UPDATE txg_temp
SET xGoalsPercentageAgainst = 1 - xGoalsPercentage, corsiPercentageAgainst = 1 - corsiPercentage, fenwickPercentageAgainst = 1 - fenwickPercentage;

ALTER TABLE txg_temp 
CHANGE xGoalsPercentage xGoalsPercentageFor FLOAT NULL DEFAULT NULL, 
CHANGE corsiPercentage corsiPercentageFor FLOAT NULL DEFAULT NULL, 
CHANGE fenwickPercentage fenwickPercentageFor FLOAT NULL DEFAULT NULL;

ALTER TABLE txg_temp 
CHANGE xGoalsPercentageAgainst xGoalsPercentageAgainst FLOAT NULL DEFAULT NULL AFTER xGoalsPercentageFor, 
CHANGE corsiPercentageAgainst corsiPercentageAgainst FLOAT NULL DEFAULT NULL AFTER corsiPercentageFor, 
CHANGE fenwickPercentageAgainst fenwickPercentageAgainst FLOAT NULL DEFAULT NULL AFTER fenwickPercentageFor;


# ADD ROWS WHERE FOR MISSING TEAMS
INSERT INTO txg_temp (game_id, team, season, opposingTeam, home_or_away, gameDate, situation, iceTime, xGoalsPercentageFor, xGoalsPercentageAgainst, corsiPercentageFor, corsiPercentageAgainst, fenwickPercentageFor, fenwickPercentageAgainst, xOnGoalFor, xGoalsFor, xReboundsFor, xFreezeFor, xPlayStoppedFor, xPlayContinuedInZoneFor, xPlayContinuedOutsideZoneFor, flurryAdjustedxGoalsFor, scoreVenueAdjustedxGoalsFor, flurryScoreVenueAdjustedxGoalsFor, shotsOnGoalFor, missedShotsFor, blockedShotAttemptsFor, shotAttemptsFor, goalsFor, reboundsFor, reboundGoalsFor, freezeFor, playStoppedFor, playContinuedInZoneFor, playContinuedOutsideZoneFor, savedShotsOnGoalFor, savedUnblockedShotAttemptsFor, penaltiesFor, penalityMinutesFor, faceOffsWonFor, hitsFor, takeawaysFor, giveawaysFor, lowDangerShotsFor, mediumDangerShotsFor, highDangerShotsFor, lowDangerxGoalsFor, mediumDangerxGoalsFor, highDangerxGoalsFor, lowDangerGoalsFor, mediumDangerGoalsFor, highDangerGoalsFor, scoreAdjustedShotsAttemptsFor, unblockedShotAttemptsFor, scoreAdjustedUnblockedShotAttemptsFor, dZoneGiveawaysFor, xGoalsFromxReboundsOfShotsFor, xGoalsFromActualReboundsOfShotsFor, reboundxGoalsFor, totalShotCreditFor, scoreAdjustedTotalShotCreditFor, scoreFlurryAdjustedTotalShotCreditFor, xOnGoalAgainst, xGoalsAgainst, xReboundsAgainst, xFreezeAgainst, xPlayStoppedAgainst, xPlayContinuedInZoneAgainst, xPlayContinuedOutsideZoneAgainst, flurryAdjustedxGoalsAgainst, scoreVenueAdjustedxGoalsAgainst, flurryScoreVenueAdjustedxGoalsAgainst, shotsOnGoalAgainst, missedShotsAgainst, blockedShotAttemptsAgainst, shotAttemptsAgainst, goalsAgainst, reboundsAgainst, reboundGoalsAgainst, freezeAgainst, playStoppedAgainst, playContinuedInZoneAgainst, playContinuedOutsideZoneAgainst, savedShotsOnGoalAgainst, savedUnblockedShotAttemptsAgainst, penaltiesAgainst, penalityMinutesAgainst, faceOffsWonAgainst, hitsAgainst, takeawaysAgainst, giveawaysAgainst, lowDangerShotsAgainst, mediumDangerShotsAgainst, highDangerShotsAgainst, lowDangerxGoalsAgainst, mediumDangerxGoalsAgainst, highDangerxGoalsAgainst, lowDangerGoalsAgainst, mediumDangerGoalsAgainst, 
highDangerGoalsAgainst, scoreAdjustedShotsAttemptsAgainst, unblockedShotAttemptsAgainst, scoreAdjustedUnblockedShotAttemptsAgainst, dZoneGiveawaysAgainst, xGoalsFromxReboundsOfShotsAgainst, xGoalsFromActualReboundsOfShotsAgainst, reboundxGoalsAgainst, totalShotCreditAgainst, scoreAdjustedTotalShotCreditAgainst, scoreFlurryAdjustedTotalShotCreditAgainst) 
SELECT game_id, opposingTeam AS team, season, team AS opposingTeam,  
CASE
  WHEN home_or_away = 'H' THEN 'A'
  ELSE 'H'
END AS home_or_away, 
gameDate, situation, iceTime, 
xGoalsPercentageAgainst AS xGoalsPercentageFor, xGoalsPercentageFor AS xGoalsPercentageAgainst, corsiPercentageAgainst AS corsiPercentageFor, corsiPercentageFor AS corsiPercentageAgainst, fenwickPercentageAgainst AS fenwickPercentageFor, fenwickPercentageFor AS fenwickPercentageAgainst, xOnGoalAgainst AS xOnGoalFor, xGoalsAgainst AS xGoalsFor, xReboundsAgainst AS xReboundsFor, xFreezeAgainst AS xFreezeFor, xPlayStoppedAgainst AS xPlayStoppedFor, xPlayContinuedInZoneAgainst AS xPlayContinuedInZoneFor, xPlayContinuedOutsideZoneAgainst AS xPlayContinuedOutsideZoneFor, flurryAdjustedxGoalsAgainst AS flurryAdjustedxGoalsFor, scoreVenueAdjustedxGoalsAgainst AS scoreVenueAdjustedxGoalsFor, flurryScoreVenueAdjustedxGoalsAgainst AS flurryScoreVenueAdjustedxGoalsFor, shotsOnGoalAgainst AS shotsOnGoalFor, missedShotsAgainst AS missedShotsFor, blockedShotAttemptsAgainst AS blockedShotAttemptsFor, shotAttemptsAgainst AS shotAttemptsFor, goalsAgainst AS goalsFor, reboundsAgainst AS reboundsFor, reboundGoalsAgainst AS reboundGoalsFor, freezeAgainst AS freezeFor, playStoppedAgainst AS playStoppedFor, playContinuedInZoneAgainst AS playContinuedInZoneFor, playContinuedOutsideZoneAgainst AS playContinuedOutsideZoneFor, savedShotsOnGoalAgainst AS savedShotsOnGoalFor, savedUnblockedShotAttemptsAgainst AS savedUnblockedShotAttemptsFor, penaltiesAgainst AS penaltiesFor, penalityMinutesAgainst AS penalityMinutesFor, faceOffsWonAgainst AS faceOffsWonFor, hitsAgainst AS hitsFor, takeawaysAgainst AS takeawaysFor, giveawaysAgainst AS giveawaysFor, lowDangerShotsAgainst AS 
lowDangerShotsFor, mediumDangerShotsAgainst AS mediumDangerShotsFor, highDangerShotsAgainst AS highDangerShotsFor, lowDangerxGoalsAgainst AS lowDangerxGoalsFor, mediumDangerxGoalsAgainst AS mediumDangerxGoalsFor, highDangerxGoalsAgainst AS highDangerxGoalsFor, lowDangerGoalsAgainst AS lowDangerGoalsFor, mediumDangerGoalsAgainst AS mediumDangerGoalsFor, highDangerGoalsAgainst AS highDangerGoalsFor, scoreAdjustedShotsAttemptsAgainst AS scoreAdjustedShotsAttemptsFor, unblockedShotAttemptsAgainst AS unblockedShotAttemptsFor, scoreAdjustedUnblockedShotAttemptsAgainst AS scoreAdjustedUnblockedShotAttemptsFor, dZoneGiveawaysAgainst AS dZoneGiveawaysFor, xGoalsFromxReboundsOfShotsAgainst AS xGoalsFromxReboundsOfShotsFor, xGoalsFromActualReboundsOfShotsAgainst AS xGoalsFromActualReboundsOfShotsFor, reboundxGoalsAgainst AS reboundxGoalsFor, totalShotCreditAgainst AS totalShotCreditFor, scoreAdjustedTotalShotCreditAgainst AS scoreAdjustedTotalShotCreditFor, scoreFlurryAdjustedTotalShotCreditAgainst AS scoreFlurryAdjustedTotalShotCreditFor, xOnGoalFor AS xOnGoalAgainst, xGoalsFor AS xGoalsAgainst, xReboundsFor AS xReboundsAgainst, xFreezeFor AS xFreezeAgainst, xPlayStoppedFor AS xPlayStoppedAgainst, xPlayContinuedInZoneFor AS xPlayContinuedInZoneAgainst, xPlayContinuedOutsideZoneFor AS xPlayContinuedOutsideZoneAgainst, flurryAdjustedxGoalsFor AS flurryAdjustedxGoalsAgainst, scoreVenueAdjustedxGoalsFor AS 
scoreVenueAdjustedxGoalsAgainst, flurryScoreVenueAdjustedxGoalsFor AS flurryScoreVenueAdjustedxGoalsAgainst, shotsOnGoalFor AS shotsOnGoalAgainst, missedShotsFor AS missedShotsAgainst, blockedShotAttemptsFor AS blockedShotAttemptsAgainst, shotAttemptsFor AS shotAttemptsAgainst, goalsFor AS goalsAgainst, reboundsFor AS reboundsAgainst, reboundGoalsFor AS reboundGoalsAgainst, freezeFor AS freezeAgainst, playStoppedFor AS playStoppedAgainst, playContinuedInZoneFor AS playContinuedInZoneAgainst, playContinuedOutsideZoneFor AS playContinuedOutsideZoneAgainst, savedShotsOnGoalFor AS savedShotsOnGoalAgainst, savedUnblockedShotAttemptsFor AS savedUnblockedShotAttemptsAgainst, penaltiesFor AS penaltiesAgainst, penalityMinutesFor AS penalityMinutesAgainst, faceOffsWonFor AS faceOffsWonAgainst, hitsFor AS hitsAgainst, takeawaysFor AS takeawaysAgainst, giveawaysFor AS giveawaysAgainst, lowDangerShotsFor AS lowDangerShotsAgainst, mediumDangerShotsFor AS mediumDangerShotsAgainst, highDangerShotsFor AS highDangerShotsAgainst, lowDangerxGoalsFor AS lowDangerxGoalsAgainst, mediumDangerxGoalsFor AS mediumDangerxGoalsAgainst, highDangerxGoalsFor AS highDangerxGoalsAgainst, lowDangerGoalsFor AS lowDangerGoalsAgainst, mediumDangerGoalsFor AS mediumDangerGoalsAgainst, highDangerGoalsFor AS highDangerGoalsAgainst, scoreAdjustedShotsAttemptsFor AS scoreAdjustedShotsAttemptsAgainst, unblockedShotAttemptsFor AS unblockedShotAttemptsAgainst, scoreAdjustedUnblockedShotAttemptsFor AS scoreAdjustedUnblockedShotAttemptsAgainst, dZoneGiveawaysFor AS dZoneGiveawaysAgainst, xGoalsFromxReboundsOfShotsFor AS xGoalsFromxReboundsOfShotsAgainst, xGoalsFromActualReboundsOfShotsFor AS xGoalsFromActualReboundsOfShotsAgainst, reboundxGoalsFor AS reboundxGoalsAgainst, totalShotCreditFor AS totalShotCreditAgainst, scoreAdjustedTotalShotCreditFor AS scoreAdjustedTotalShotCreditAgainst, scoreFlurryAdjustedTotalShotCreditFor AS scoreFlurryAdjustedTotalShotCreditAgainst FROM txg_temp 
WHERE (opposingTeam, game_id) NOT IN (select team, game_id from txg_temp);

# CREATE NEW HOME/AWAY BASED TABLE ONCE ALL GAMES HAVE BOTH TEAM ROWS
CREATE TABLE team_x_game_even_2020 AS SELECT game_id, team AS home_team, season, opposingTeam AS away_team, gameDate, situation, iceTime, xGoalsPercentageFor AS xGoalsPercentageHome, xGoalsPercentageAgainst AS xGoalsPercentageAway, corsiPercentageFor AS corsiPercentageHome, corsiPercentageAgainst AS corsiPercentageAway, fenwickPercentageFor AS fenwickPercentageHome, fenwickPercentageAgainst AS fenwickPercentageAway, xOnGoalFor AS xOnGoalHome, xGoalsFor AS xGoalsHome, xReboundsFor AS xReboundsHome, xFreezeFor AS xFreezeHome, xPlayStoppedFor AS xPlayStoppedHome, xPlayContinuedInZoneFor 
AS xPlayContinuedInZoneHome, xPlayContinuedOutsideZoneFor AS xPlayContinuedOutsideZoneHome, flurryAdjustedxGoalsFor AS flurryAdjustedxGoalsHome, scoreVenueAdjustedxGoalsFor AS scoreVenueAdjustedxGoalsHome, flurryScoreVenueAdjustedxGoalsFor AS flurryScoreVenueAdjustedxGoalsHome, shotsOnGoalFor AS shotsOnGoalHome, missedShotsFor AS missedShotsHome, blockedShotAttemptsFor AS blockedShotAttemptsHome, shotAttemptsFor AS shotAttemptsHome, goalsFor AS goalsHome, reboundsFor 
AS reboundsHome, reboundGoalsFor AS reboundGoalsHome, freezeFor AS freezeHome, playStoppedFor AS playStoppedHome, playContinuedInZoneFor AS playContinuedInZoneHome, playContinuedOutsideZoneFor AS playContinuedOutsideZoneHome, savedShotsOnGoalFor AS savedShotsOnGoalHome, savedUnblockedShotAttemptsFor AS savedUnblockedShotAttemptsHome, penaltiesFor AS penaltiesHome, penalityMinutesFor AS penalityMinutesHome, faceOffsWonFor AS faceOffsWonHome, hitsFor AS hitsHome, takeawaysFor AS takeawaysHome, giveawaysFor AS giveawaysHome, lowDangerShotsFor AS lowDangerShotsHome, mediumDangerShotsFor 
AS mediumDangerShotsHome, highDangerShotsFor AS highDangerShotsHome, lowDangerxGoalsFor AS lowDangerxGoalsHome, mediumDangerxGoalsFor AS mediumDangerxGoalsHome, highDangerxGoalsFor AS highDangerxGoalsHome, lowDangerGoalsFor AS lowDangerGoalsHome, mediumDangerGoalsFor AS mediumDangerGoalsHome, highDangerGoalsFor AS highDangerGoalsHome, scoreAdjustedShotsAttemptsFor AS scoreAdjustedShotsAttemptsHome, unblockedShotAttemptsFor AS unblockedShotAttemptsHome, scoreAdjustedUnblockedShotAttemptsFor AS scoreAdjustedUnblockedShotAttemptsHome, dZoneGiveawaysFor AS dZoneGiveawaysHome, xGoalsFromxReboundsOfShotsFor AS xGoalsFromxReboundsOfShotsHome, xGoalsFromActualReboundsOfShotsFor AS xGoalsFromActualReboundsOfShotsHome, reboundxGoalsFor AS reboundxGoalsHome, totalShotCreditFor AS totalShotCreditHome, scoreAdjustedTotalShotCreditFor AS scoreAdjustedTotalShotCreditHome, scoreFlurryAdjustedTotalShotCreditFor AS scoreFlurryAdjustedTotalShotCreditHome, xOnGoalAgainst AS xOnGoalAway, xGoalsAgainst AS xGoalsAway, xReboundsAgainst AS xReboundsAway, xFreezeAgainst AS xFreezeAway, xPlayStoppedAgainst AS xPlayStoppedAway, xPlayContinuedInZoneAgainst AS xPlayContinuedInZoneAway, xPlayContinuedOutsideZoneAgainst AS xPlayContinuedOutsideZoneAway, flurryAdjustedxGoalsAgainst AS flurryAdjustedxGoalsAway, scoreVenueAdjustedxGoalsAgainst AS scoreVenueAdjustedxGoalsAway, flurryScoreVenueAdjustedxGoalsAgainst AS flurryScoreVenueAdjustedxGoalsAway, shotsOnGoalAgainst AS shotsOnGoalAway, missedShotsAgainst AS missedShotsAway, blockedShotAttemptsAgainst AS blockedShotAttemptsAway, shotAttemptsAgainst AS shotAttemptsAway, goalsAgainst AS goalsAway, reboundsAgainst AS reboundsAway, reboundGoalsAgainst AS reboundGoalsAway, freezeAgainst AS freezeAway, playStoppedAgainst AS playStoppedAway, playContinuedInZoneAgainst AS playContinuedInZoneAway, playContinuedOutsideZoneAgainst AS playContinuedOutsideZoneAway, savedShotsOnGoalAgainst AS savedShotsOnGoalAway, savedUnblockedShotAttemptsAgainst AS savedUnblockedShotAttemptsAway, penaltiesAgainst AS penaltiesAway, penalityMinutesAgainst AS penalityMinutesAway, faceOffsWonAgainst AS faceOffsWonAway, hitsAgainst AS hitsAway, takeawaysAgainst AS takeawaysAway, giveawaysAgainst AS giveawaysAway, lowDangerShotsAgainst AS lowDangerShotsAway, mediumDangerShotsAgainst AS mediumDangerShotsAway, highDangerShotsAgainst AS 
highDangerShotsAway, lowDangerxGoalsAgainst AS lowDangerxGoalsAway, mediumDangerxGoalsAgainst AS mediumDangerxGoalsAway, highDangerxGoalsAgainst AS highDangerxGoalsAway, lowDangerGoalsAgainst AS lowDangerGoalsAway, mediumDangerGoalsAgainst AS mediumDangerGoalsAway, highDangerGoalsAgainst AS highDangerGoalsAway, scoreAdjustedShotsAttemptsAgainst AS scoreAdjustedShotsAttemptsAway, unblockedShotAttemptsAgainst AS unblockedShotAttemptsAway, scoreAdjustedUnblockedShotAttemptsAgainst AS scoreAdjustedUnblockedShotAttemptsAway, dZoneGiveawaysAgainst AS dZoneGiveawaysAway, xGoalsFromxReboundsOfShotsAgainst AS xGoalsFromxReboundsOfShotsAway, xGoalsFromActualReboundsOfShotsAgainst AS xGoalsFromActualReboundsOfShotsAway, reboundxGoalsAgainst AS reboundxGoalsAway, totalShotCreditAgainst AS totalShotCreditAway, scoreAdjustedTotalShotCreditAgainst AS scoreAdjustedTotalShotCreditAway, scoreFlurryAdjustedTotalShotCreditAgainst AS scoreFlurryAdjustedTotalShotCreditAway 
FROM txg_temp WHERE home_or_away = 'H';

# DROP TEMP TABLE
DROP TABLE txg_temp;

